<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจผลรางวัลจากรูปภาพ</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 0; padding: 1em; background-color: #f0f2f5; }
        .container { max-width: 600px; margin: auto; background: white; padding: 2em; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1c1e21; }
        .form-group { margin-bottom: 1.5em; }
        label { display: block; margin-bottom: 0.5em; font-weight: bold; color: #4b4f56; }
        select, input[type="file"], button { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #dddfe2; font-size: 1em; font-family: 'Sarabun', sans-serif; box-sizing: border-box; }
        input[type="file"] { border: 2px dashed #dddfe2; background-color: #f7f7f7; }
        button { background-color: #1877f2; color: white; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #166fe5; }
        button:disabled { background-color: #9dbcf3; cursor: not-allowed; }
        #ocr-status { text-align: center; padding: 1em; color: #333; font-weight: bold; background-color: #e9ecef; border-radius: 5px; margin-top: 1em; display: none; }
        #result-container { margin-top: 1em; }
        .result-item { padding: 0.8em; border-bottom: 1px solid #e0e0e0; }
        .result-item:last-child { border-bottom: none; }
        .win { color: green; font-weight: bold; }
        .lose { color: #888; }
        .win::after { content: ' ✅ ยินดีด้วย! คุณถูกรางวัล'; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>
<body>

    <div class="container">
        <h1>ตรวจผลรางวัลจากรูปภาพ</h1>

        <div class="form-group">
            <label for="lotto-type">1. เลือกประเภทหวย</label>
            <select id="lotto-type">
                <option value="ฮานอย ปกติ">ฮานอย ปกติ</option>
                <option value="ลาวพัฒนา">ลาวพัฒนา</option>
                <option value="ฮานอย พิเศษ">ฮานอย พิเศษ</option>
            </select>
        </div>

        <div class="form-group">
            <label for="lotto-image">2. อัปโหลดรูปภาพสลิป</label>
            <input type="file" id="lotto-image" accept="image/*">
        </div>

        <button id="check-button">ตรวจผลรางวัล</button>

        <div id="ocr-status"></div>
        <div id="result-container"></div>
    </div>

    <script>
        // -----------------------------------------------------------------
        // ✨ วางลิงก์ CSV ของ "ผลรางวัล" ที่คัดลอกมา ตรงนี้ ✨
        // -----------------------------------------------------------------
        const winningSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQiBp4Z2XVrllF6aly9pAtFZexQmMfz3fHvvQQE2o5HfhtioEWj4KWTj7uXZh_xwm5Fbi336KKipD4_/pub?output=csv';

        const checkButton = document.getElementById('check-button');
        const imageInput = document.getElementById('lotto-image');
        const ocrStatus = document.getElementById('ocr-status');
        const resultContainer = document.getElementById('result-container');

        checkButton.addEventListener('click', handleCheck);

        const sortString = (str) => str ? str.split('').sort().join('') : '';

        // ฟังก์ชันสำหรับแยกข้อความที่ OCR อ่านได้
        function parseOcrText(text) {
            const bets = [];
            const lines = text.split('\n');
            // Regex นี้พยายามจับ "เลข" ตามด้วย "ราคา" ในบรรทัดเดียวกัน
            // \b(\d{2,3})\b คือเลข 2-3 ตัว
            // (\d+)\s* คือราคา 1 ตัวเลขหรือมากกว่า
            const regex = /\b(\d{2,3})\b\s+(\d+)\s*(\d+)?\s*(\d+)?/g;

            for (const line of lines) {
                // เราสนใจบรรทัดที่มีแต่ตัวเลขและช่องว่าง
                if (/^[\d\s]+$/.test(line.trim())) {
                    const parts = line.trim().split(/\s+/); // แบ่งด้วยช่องว่าง
                    if (parts.length >= 2) {
                        bets.push({
                            number: parts[0],
                            betTop: parts[1],
                            betBottom: parts.length > 2 ? parts[2] : null, // ถ้ามีคอลัมน์ที่ 3
                            betTod: parts.length > 3 ? parts[3] : null, // ถ้ามีคอลัมน์ที่ 4 (แบบในรูปคือโต๊ด)
                        });
                    }
                }
            }
             console.log("Parsed bets:", bets);
            return bets;
        }

        async function handleCheck() {
            const lottoType = document.getElementById('lotto-type').value;
            const imageFile = imageInput.files[0];

            if (!imageFile) {
                alert('กรุณาเลือกรูปภาพก่อน');
                return;
            }

            // --- เริ่มกระบวนการ OCR ---
            checkButton.disabled = true;
            ocrStatus.style.display = 'block';
            ocrStatus.textContent = 'กำลังเตรียมตัวอ่านภาพ...';
            resultContainer.innerHTML = '';

            try {
                const worker = await Tesseract.createWorker('tha+eng');
                ocrStatus.textContent = 'กำลังประมวลผลและดึงข้อความจากภาพ... (อาจใช้เวลาสักครู่)';
                
                const { data: { text } } = await worker.recognize(imageFile);
                await worker.terminate();

                ocrStatus.textContent = 'ดึงข้อความสำเร็จ! กำลังตรวจสอบกับผลรางวัล...';
                console.log("Raw OCR Text:", text); // แสดงข้อความดิบที่อ่านได้ใน Console เพื่อดีบัก

                // --- เริ่มตรวจสอบกับผลรางวัล ---
                const userBets = parseOcrText(text);
                if (userBets.length === 0) {
                     resultContainer.innerHTML = '<p style="color:red;">ไม่สามารถหาข้อมูลตัวเลขจากรูปภาพได้ กรุณาลองกับภาพที่ชัดเจนกว่านี้</p>';
                     return;
                }

                const response = await fetch(winningSheetUrl);
                const csvText = await response.text();
                const winningRows = csvText.split('\n');
                const headers = winningRows[0].split(',');
                
                let winningNumbers = null;
                const todayWinningRow = winningRows.slice(1).find(row => row.split(',')[headers.indexOf('LotteryName')] === lottoType);

                if (todayWinningRow) {
                    const cols = todayWinningRow.split(',');
                    winningNumbers = {
                        top3: cols[headers.indexOf('Prize3Top')]?.trim(),
                        bottom2: cols[headers.indexOf('Prize2Bottom')]?.trim(),
                    };
                } else {
                    resultContainer.innerHTML = `<p>ไม่พบผลรางวัลสำหรับ "${lottoType}" ในวันนี้</p>`;
                    return;
                }

                let finalHtml = '<h3>ผลการตรวจสอบ:</h3>';
                userBets.forEach(bet => {
                    let isWin = false;
                    // ตรวจ 3 ตัวบน
                    if (bet.number === winningNumbers.top3 && bet.betTop) isWin = true;
                    // ตรวจ 2 ตัวล่าง
                    if (bet.number === winningNumbers.bottom2 && bet.betBottom) isWin = true;
                    // ตรวจ 2 ตัวบน
                    if (bet.number.length === 2 && bet.number === winningNumbers.top3?.slice(-2) && bet.betTop) isWin = true;
                    // ตรวจ 3 ตัวโต๊ด
                    if (bet.number.length === 3 && bet.betTod && sortString(bet.number) === sortString(winningNumbers.top3)) isWin = true;

                    finalHtml += `<div class="result-item ${isWin ? 'win' : 'lose'}">เลข ${bet.number}</div>`;
                });
                resultContainer.innerHTML = finalHtml;

            } catch (error) {
                console.error(error);
                resultContainer.innerHTML = '<p style="color:red;">เกิดข้อผิดพลาดร้ายแรงระหว่างการประมวลผล</p>';
            } finally {
                ocrStatus.style.display = 'none';
                checkButton.disabled = false;
            }
        }
    </script>
</body>
</html>
